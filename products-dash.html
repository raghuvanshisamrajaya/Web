<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Product Manager</title>
  <style>
    body { font-family: sans-serif; margin: 0; background: #f4f4f4; padding: 20px; }
    .container { max-width: 1200px; margin: auto; display: flex; flex-direction: column; gap: 20px; }
    form, .preview, .product-list { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    form { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
    input, textarea { padding: 8px; border-radius: 6px; border: 1px solid #ccc; width: 100%; }
    input[type="submit"] { background: #1976d2; color: white; font-weight: bold; cursor: pointer; }
    input[type="submit"]:hover { background: #155a9e; }
    .preview img { max-width: 100%; max-height: 200px; border-radius: 8px; object-fit: cover; }
    .tags { display: flex; gap: 6px; flex-wrap: wrap; }
    .tag { background: #1976d2; color: white; padding: 4px 10px; border-radius: 20px; font-size: 13px; }
    .product-card { border: 1px solid #ddd; padding: 15px; border-radius: 10px; display: flex; flex-direction: column; gap: 8px; background: #fff; }
    .product-card img { width: 100%; max-height: 180px; object-fit: cover; border-radius: 8px; }
    .product-card button { background: #1976d2; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; margin-right: 10px; }
    .product-card .delete { background-color: #d32f2f; }
    #notAuthorized { color: red; text-align: center; font-weight: bold; display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Admin Product Manager</h2>
    <div id="notAuthorized">Access Denied: Admins only.</div>
    
    <form id="productForm" style="display:none;">
      <input type="hidden" id="docId" />
      <input type="text" id="name" placeholder="Product Name" required />
      <input type="text" id="brand" placeholder="Brand" />
      <input type="text" id="category" placeholder="Category" />
      <textarea id="desc" placeholder="Description"></textarea>
      <input type="number" id="price" placeholder="Price" />
      <input type="number" id="discount" placeholder="Discount (%)" />
      <input type="number" id="stock" placeholder="Stock" />
      <input type="number" step="0.1" id="rating" placeholder="Rating" />
      <input type="text" id="tags" placeholder="Tags (comma-separated)" />
      <input type="url" id="imageUrl" placeholder="Image URL" />
      <input type="submit" value="Save Product" />
    </form>

    <div class="preview" id="previewBox" style="display:none;">
      <h3>Live Preview</h3>
      <img id="previewImage" src="https://via.placeholder.com/300x200?text=Preview" alt="Preview" />
      <p><strong>Name:</strong> <span id="pname"></span></p>
      <p><strong>Brand:</strong> <span id="pbrand"></span></p>
      <p><strong>Category:</strong> <span id="pcategory"></span></p>
      <p><strong>Price:</strong> ₹<span id="pprice"></span> | Discount: <span id="pdiscount"></span>%</p>
      <p><strong>Stock:</strong> <span id="pstock"></span> | Rating: <span id="prating"></span></p>
      <p><strong>Description:</strong> <span id="pdesc"></span></p>
      <div class="tags" id="ptags"></div>
    </div>

    <div class="product-list" id="productSection" style="display:none;">
      <h3>All Products</h3>
      <div id="productCards" style="display:grid; gap:15px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));"></div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAbknkfD6Je1a3wDZRTzn6c62CNUhhwLc",
      authDomain: "store-471f1.firebaseapp.com",
      projectId: "store-471f1",
      storageBucket: "store-471f1.appspot.com",
      messagingSenderId: "619523242611",
      appId: "1:619523242611:web:fdfa53044c62f844574806",
      measurementId: "G-16C8MYT70G"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const form = document.getElementById('productForm');
    const docId = document.getElementById('docId');
    const previewImage = document.getElementById('previewImage');

    const userData = { email: null };

    const updatePreview = () => {
      previewImage.src = imageUrl.value || "https://via.placeholder.com/300x200?text=Preview";
      pname.innerText = name.value;
      pbrand.innerText = brand.value;
      pcategory.innerText = category.value;
      pprice.innerText = price.value;
      pdiscount.innerText = discount.value;
      pstock.innerText = stock.value;
      prating.innerText = rating.value;
      pdesc.innerText = desc.value;

      const tagsContainer = document.getElementById("ptags");
      tagsContainer.innerHTML = "";
      tags.value.split(",").forEach(tag => {
        if (tag.trim()) {
          const span = document.createElement("span");
          span.className = "tag";
          span.innerText = tag.trim();
          tagsContainer.appendChild(span);
        }
      });
    };

    form.addEventListener("input", updatePreview);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const product = {
        name: name.value,
        brand: brand.value,
        category: category.value,
        desc: desc.value,
        price: +price.value,
        discount: +discount.value,
        stock: +stock.value,
        rating: +rating.value,
        tags: tags.value.split(",").map(t => t.trim()),
        imageUrl: imageUrl.value,
        createdBy: userData.email,
        updatedBy: userData.email,
        createdAt: new Date(),
        updatedAt: new Date(),
      };

      if (docId.value) {
        await updateDoc(doc(db, "products", docId.value), product);
        alert("Product updated!");
      } else {
        await addDoc(collection(db, "products"), product);
        alert("Product created!");
      }

      form.reset();
      docId.value = "";
      updatePreview();
      loadProducts();
    });

    async function loadProducts() {
      const querySnapshot = await getDocs(collection(db, "products"));
      const productCards = document.getElementById("productCards");
      productCards.innerHTML = "";

      querySnapshot.forEach((docSnap) => {
        const p = docSnap.data();
        const card = document.createElement("div");
        card.className = "product-card";
        card.innerHTML = `
          <img src="${p.imageUrl}" alt="${p.name}" />
          <h4>${p.name}</h4>
          <p><strong>₹${p.price}</strong> - ${p.brand}</p>
          <p>${p.category} | ⭐ ${p.rating}</p>
          <p>Stock: ${p.stock}</p>
          <div>
            <button onclick="editProduct('${docSnap.id}')">Edit</button>
            <button class="delete" onclick="deleteProduct('${docSnap.id}')">Delete</button>
          </div>
        `;
        productCards.appendChild(card);
      });
    }

    window.editProduct = async (id) => {
      const ref = doc(db, "products", id);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const p = snap.data();
        name.value = p.name;
        brand.value = p.brand;
        category.value = p.category;
        desc.value = p.desc;
        price.value = p.price;
        discount.value = p.discount;
        stock.value = p.stock;
        rating.value = p.rating;
        tags.value = p.tags.join(",");
        imageUrl.value = p.imageUrl;
        docId.value = id;
        updatePreview();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    };

    window.deleteProduct = async (id) => {
      if (confirm("Are you sure you want to delete this product?")) {
        await deleteDoc(doc(db, "products", id));
        alert("Product deleted!");
        loadProducts();
      }
    };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const role = userDoc.exists() ? userDoc.data().role : null;
        userData.email = user.email;

        if (role === "admin") {
          form.style.display = "grid";
          document.getElementById("previewBox").style.display = "block";
          document.getElementById("productSection").style.display = "block";
          loadProducts();
          updatePreview();
        } else {
          document.getElementById("notAuthorized").style.display = "block";
        }
      } else {
        alert("You must be logged in as an admin to use this page.");
        location.href = "/login.html"; // redirect if needed
      }
    });
  </script>
</body>
</html>
