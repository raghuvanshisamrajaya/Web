<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Doctor Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f1f5f9;
      margin: 0;
      padding: 2rem;
    }
    h1 {
      text-align: center;
      color: #2563eb;
      margin-bottom: 1rem;
    }
    .summary {
      text-align: center;
      margin-bottom: 2rem;
    }
    .summary p {
      font-weight: 600;
      color: #1e293b;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    input, select {
      padding: 0.6rem 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
    }
    .legend {
      text-align: center;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      color: #4b5563;
    }
    .card {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 5px 20px rgba(0,0,0,0.05);
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      transition: all 0.3s ease;
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(10px);}
      to {opacity: 1; transform: translateY(0);}
    }
    .card:hover {
      transform: scale(1.01);
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    }
    .card p {
      margin: 0.5rem 0;
    }
    .status-badge {
      display: inline-block;
      padding: 0.3rem 0.7rem;
      border-radius: 0.5rem;
      font-size: 0.85rem;
      font-weight: 600;
      color: white;
    }
    .pending { background: #f59e0b; }
    .confirmed { background: #10b981; }
    .completed { background: #2563eb; }
    .rejected { background: #ef4444; }
    button, select {
      margin-top: 0.5rem;
      font-size: 1rem;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      border: none;
      cursor: pointer;
    }
    button {
      background: #2563eb;
      color: white;
    }
    button:hover {
      background: #1e40af;
    }
  </style>
</head>
<body>
  <h1>Doctor Dashboard</h1>
  <div class="summary" id="summaryStats"></div>
  <div class="legend">
    <span class="status-badge pending">Pending</span>
    <span class="status-badge confirmed">Confirmed</span>
    <span class="status-badge completed">Completed</span>
    <span class="status-badge rejected">Rejected</span>
  </div>
  <div class="controls">
    <input type="text" id="searchInput" placeholder="Search by patient or invoice...">
    <select id="statusFilter">
      <option value="">All Statuses</option>
      <option value="pending">Pending</option>
      <option value="confirmed">Confirmed</option>
      <option value="completed">Completed</option>
      <option value="rejected">Rejected</option>
    </select>
  </div>
  <div id="bookingsContainer"></div>  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, updateDoc, doc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAbknkfD6Je1a3wDZRTzn6lC62CNUhhwLc",
      authDomain: "store-471f1.firebaseapp.com",
      projectId: "store-471f1",
      storageBucket: "store-471f1.appspot.com",
      messagingSenderId: "619523242611",
      appId: "1:619523242611:web:fdfa53044c62f844574806"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const container = document.getElementById("bookingsContainer");
    const searchInput = document.getElementById("searchInput");
    const statusFilter = document.getElementById("statusFilter");
    const summary = document.getElementById("summaryStats");

    let bookings = [];
    let servicesMap = new Map();

    function renderBookings(list) {
      container.innerHTML = "";
      list.forEach(b => {
        const card = document.createElement("div");
        card.className = "card";
        const serviceName = servicesMap.get(b.serviceId) || b.serviceId;
        card.innerHTML = `
          <p><strong>Invoice:</strong> ${b.invoiceId}</p>
          <p><strong>Patient:</strong> ${b.name}</p>
          <p><strong>Email:</strong> ${b.email}</p>
          <p><strong>Phone:</strong> ${b.phone}</p>
          <p><strong>Location:</strong> ${b.location}</p>
          <p><strong>Service:</strong> ${serviceName}</p>
          <p><strong>Date:</strong> ${b.date}</p>
          <p><strong>Status:</strong> <span class="status-badge ${b.status}">${b.status.toUpperCase()}</span></p>
          <select id="status-${b.id}">
            <option disabled selected>Update Status</option>
            <option value="pending">Pending</option>
            <option value="confirmed">Confirmed</option>
            <option value="completed">Completed</option>
            <option value="rejected">Rejected</option>
          </select>
          <button onclick="updateStatus('${b.id}')">Update</button>
        `;
        container.appendChild(card);
      });
    }

    function updateSummary(list) {
      const total = list.length;
      const pending = list.filter(b => b.status === "pending").length;
      const confirmed = list.filter(b => b.status === "confirmed").length;
      const completed = list.filter(b => b.status === "completed").length;
      const rejected = list.filter(b => b.status === "rejected").length;

      summary.innerHTML = `
        <p>Total: ${total} | Pending: ${pending} | Confirmed: ${confirmed} | Completed: ${completed} | Rejected: ${rejected}</p>
      `;
    }

    window.updateStatus = async (id) => {
      const status = document.getElementById(`status-${id}`).value;
      if (!status) return;
      await updateDoc(doc(db, "bookings", id), { status });
      alert("Status updated");
    };

    function filterBookings() {
      const keyword = searchInput.value.toLowerCase();
      const status = statusFilter.value;
      const filtered = bookings.filter(b => {
        return (
          (b.name.toLowerCase().includes(keyword) || b.invoiceId.toLowerCase().includes(keyword)) &&
          (!status || b.status === status)
        );
      });
      renderBookings(filtered);
      updateSummary(filtered);
    }

    searchInput.addEventListener("input", filterBookings);
    statusFilter.addEventListener("change", filterBookings);

    async function loadServices() {
      const snap = await getDocs(collection(db, "services"));
      snap.forEach(doc => {
        servicesMap.set(doc.id, doc.data().title || "Unnamed Service");
      });
    }

    async function getRole(uid) {
      const snap = await getDocs(collection(db, "users"));
      const docu = snap.docs.find(d => d.id === uid);
      return docu?.data()?.role || null;
    }

    onAuthStateChanged(auth, async user => {
      if (user) {
        const role = await getRole(user.uid);
        if (role === "doctor") {
          await loadServices();
          onSnapshot(collection(db, "bookings"), snap => {
            bookings = snap.docs
              .map(doc => ({ id: doc.id, ...doc.data() }))
              .filter(b => b.assignedDoctor === user.email);
            filterBookings();
          });
        } else {
          alert("Access denied. Doctor only.");
          window.location.href = "index.html";
        }
      }
    });
  </script></body>
</html>
